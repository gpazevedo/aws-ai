name: Deploy Lambda - Production

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::234876310489:role/aws-ai-github-actions-prod
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Lambda Docker image
        id: build-and-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: aws-ai
          ENVIRONMENT: prod
          GIT_SHA: ${{ github.sha }}
          SERVICE_FOLDER: api
          IMAGE_NAME: api
        run: |
          cd backend
          # Build image with multiple tags
          # Format: {folder}/{env}/{folder}-{datetime}-{sha}, {folder}/{env}/{folder}-latest, {folder}/{env}/latest
          SHORT_SHA=${GIT_SHA:0:7}
          TIMESTAMP=$(date -u +%Y-%m-%d-%H-%M)

          # Primary tag: api/prod/api-2025-11-18-21-02-abc1234
          PRIMARY_TAG="${IMAGE_NAME}/${ENVIRONMENT}/${IMAGE_NAME}-${TIMESTAMP}-${SHORT_SHA}"

          # Build image with SERVICE_FOLDER parameter
          docker build \
            --build-arg SERVICE_FOLDER=${SERVICE_FOLDER} \
            --platform linux/arm64 \
            -f Dockerfile.lambda \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$PRIMARY_TAG \
            .

          # Push primary tag
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$PRIMARY_TAG

          # Tag and push: api/prod/api-latest
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$PRIMARY_TAG \
            $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_NAME}/${ENVIRONMENT}/${IMAGE_NAME}-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_NAME}/${ENVIRONMENT}/${IMAGE_NAME}-latest

          # Tag and push: api/prod/latest (for quick rollback)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$PRIMARY_TAG \
            $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_NAME}/${ENVIRONMENT}/latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_NAME}/${ENVIRONMENT}/latest

          echo "IMAGE_TAG=$PRIMARY_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed image tags:"
          echo "  - $PRIMARY_TAG"
          echo "  - ${IMAGE_NAME}/${ENVIRONMENT}/${IMAGE_NAME}-latest"
          echo "  - ${IMAGE_NAME}/${ENVIRONMENT}/latest"

      - name: Update Lambda function
        env:
          IMAGE_TAG: ${{ steps.build-and-push.outputs.IMAGE_TAG }}
        run: |
          aws lambda update-function-code \
            --function-name aws-ai-prod-api \
            --image-uri ${{ steps.login-ecr.outputs.registry }}/aws-ai:${IMAGE_TAG}
